第4章	人脸识别模块研发与应用
4.1	系统分析与设计
4.1.1	需求分析
人脸识别模块作为整个审计系统的一部分，其功能需求来自与三个方面：审计人员，飞行检查人员，系统管理员。飞行检查人员需要提前采集审查对象的人脸信息，采集完毕后存放到系统内作为数据库。审计人员可以通过后台调取所有审核对象的人脸信息。系统管理员负责整个系统，具有最高的管理权限。系统的主要功能包括人员登录与权限检查，图片上传，人脸检测，人脸身份对比，人脸标签设置。
飞行检查人员通过现场拍摄的人脸图像并将其发送到后台人脸识别系统进行处理和识别。在后台，服务端按照一定的时间间隔对提箱进行预处理。在对图像中的人脸进行人脸检测。将检测到的人脸进行人脸图像质量评估之后，由系统的人脸识别模块做人脸特征提取并与数据库中的人脸信息特征对比。然后根据对比结果对审核对象的身份做出识别，后续生成风险报告。
下面从系统用户的角度，描述系统的需求。
（1）飞行检查人员
飞行检查人员通过现场收集审核对象的人脸信息并上传审核对象的图像信息。飞行检查人员的主要功能有修改密码，登录，查看个人上传的审核对象人脸图像。
（2）审核人员
审核人员的主要功能是确定审核对象在某场活动中是否出息，确定审核对象是否合规。通过调取某场活动中的人脸图像，是否与关键人脸库匹配加以确认。
（3）管理员
管理员的职责是管理并维护整个系统，管理员有着最高的系统管理权限。管理员登录后，可以对审计人员和飞检人员的信息进行维护。
4.1.2	架构设计
整个系统采用的是浏览器-服务器架构设计，审计人员通过浏览器登录系统查看审计对象的图像信息和活动的风险信息。这个架构设计相对于客户端-服务器架构更方便升级和维护，而且安全性更好。
系统的架构设计图如下所示： 
人脸上传模块是系统的数据采集来源。这一模块的主要功能是手机人脸信息并将每一张人脸图像做标签存入本地数据库。系统的服务层包含人脸检测模块，人脸识别模块，这一层的设计包含对人脸图像使用人脸检测算法，用改进后的人脸识别模型对对输入进来的人脸进行检测识别。人脸信息管理模块，是能够将那些人脸甄别那些人脸信息有问题，展示审计的结果，会将审计对象的编号，姓名，参加的活动编号等信息进行展示。审计人员可以通过登录该系统查看审计对象和活动的相关信息。数据层的主要功能就是存储人脸图像信息以及活动信息，可以起到存储备份的作用。
4.1.3	技术方案
系统通过本文的第三章改进的人脸识别算法进行人脸识别。通过自己训练的FaceNet人脸识别网络对人脸图像进行特征提取和特征对比已获得识别的结果。整个系统详细的开发环境如下所示：
表 4-1 开发环境
名称	详情
操作系统	Windows10
继承开发环境	Pycharm
开发语言	Python
深度学习框架	Pytorch 1.4
GPU	GTX 1660Ti
Web框架	Flask
PyTorch是一个开源的Python机器学习库，由Facebook人工智能研究院（FAIR）基于Torch推出。它是一个基于Python的可续计算包，提供两个高级功能：1、具有强大的GPU加速的张量计算（如NumPy）。2、包含自动求导系统的深度神经网络。
Facenet就是基于Pytorch的人脸识别框架，因此用于研发人脸识别算法非常的适合和方便。
Flask是一个使用python编写的web应用程序框架，非常适合开发基于python的web服务。其中自带的jinja2模板引擎用来开发页面，代码非常的简洁且高效。
4.1.4	业务流程
系统业务流程如图4-3所示：
图4-3 系统业务流程图 

飞检员的用例图（见图4-4）
 
图 4-4 飞检员用例图


审计人员的用例图（见图4-5）：
 
图 4-5 审计人员用例图
4.2	详细设计与实现
系统的详细设计内容主要包括数据库的设计，各个功能的设计，根据功能进行的后端接口设计，以及前端页面的设计。
4.2.1	数据库设计


良好的数据库设计能够节省数据的存储空间，能够保证数据的完整性，又方便进行数据库应用系统的开发。在审计调查场景的人脸识别应用中，基于审计调查的相关需求，设计出五个实体，对应五张表，ER关系如图4-6所示 。

4.2.1.1	用户数据表设计
用户数据表主要用于保存登录系统的用户的信息，同时对用户进行角色等级区分，每个角色的权限不一样，在系统界面中所展示的的功能和界面也不一样。这样角色权限分明，职责也分明，让每种角色的用户都能都更加快速方便的使用系统。
根据实际需求，设计用户数据表有如下几个字段：编号，角色，用户名，登录密码，权限等级（见表4-2）。
表4-2 数据表user_info
字段	类型	主键	非空	字段说明
id	Long int	True	True	编号
Username	varchar	False	True	用户名
password	Varchar	False	True	用户密码
role	Varchar	False	True	角色
authority	int	False	True	权限

4.2.1.2	活动表设计
活动表保存的信息是飞检员去活动现场（包括会议，聚餐等）记录的活动信息，详细的活动表记录也是为了方便审计人员对活动的风险评估。活动表包括的字主要字段有：活动编号，活动时间，人脸图像集位置（见表4-3）。
表4-3 数据表activity_info
字段	类型	主键	非空	字段说明
Id	Long int	True	True	编号
Time	Varchar	False	True	活动时间
Img_dir	Varchar	False	True	人脸图像集的存放位置

4.2.1.3	人脸图像数据表设计
人脸图像数据来源主要是飞检员上传的现场图片,图片上传后经过人脸检测算法检测到人脸后进行人脸分割，分割成一张张单个人脸。主要字段有：人脸图像，标记的标签，检测的标签，标记与检测是否一致（见表4-4）。
表4-4 数据表face_info
字段	类型	主键	非空	字段说明
Id	Long int	True	True	人脸编号
Mark_label	Varchar	False	false	人脸标记标签
Detect_label	Varchar	False	False	检测出的标签
Is_same	Bool	False	false	标记与检测是否一致

4.2.1.4	人物数据表设计
本地关键人物数据表数据来源是事先导入的任务信息库以及之前审核所慢慢存储起来的数据库。这张数据表的信息是审计人员核对上传人脸的基准。主要字段有：人物编号，人物图像集，人物标签，其他相关信息（见表4-5）。
表4-5 数据表person
字段	类型	主键	非空	字段说明
Id	Long int	True	True	人物编号
Faces	Varchar	False	False	人物对应的人脸集
Label	Varchar	False	True	人物标签
Details	Varchar	False	False	详细信息


4.2.1.5	本地人脸标签库和活动的关系表
由于某些关键人物可能出席多场活动，而活动中的关键人物又不止一个，因此关键人物与活动是属于多对多的关系，为了方便通过关键人物查询活动以及通过活动查询关键人物，因此设计一张关键人物与活动的关系表，便于相互查询和编辑，从而降低了复杂度以及提高系统的运行性能。关系表所包含的字段有: 关系编号，活动编号，人物编号（见表4-6）。
表4-6数据表rel_activity_person
字段	类型	主键	非空	字段说明
Id	Long int	True	True	关系编号
Activity_Id	Long int	False	True	活动编号
person_Id	Long int	False	True	人物编号

4.2.2	功能设计与实现
4.2.2.1	人脸数据采集与管理
人脸图像的来源主要是飞检员在活动现场拍摄所得的照片。飞检员通过创建活动并上传活动对应的照片集。那么这个过程（见图4-7），人脸主要就是需要对活动表的创建以及编辑，同时上传对应的人脸数据。所涉及到的数据表是activity_info,这个表中的字段img_dir就是存储的是飞检员上传的图片保存路径，这些照片就是待检测和识别的人脸数据集。并且对其中一些关键人脸进行标记。

4.2.2.2	人脸检测
选择飞检员上传的现场图像数据集，然后对该数据集进行人脸检测操作，这里的人脸检测使用的是MTCNN人脸检测器。检测的同时能够对人脸进行人脸校正，同时分割出人脸区域，将分割后的一张张人脸图像展示在浏览器界。
4.2.2.3	人脸识别
经过一系列的人脸预处理之后的人脸数据集，就可以输入到经过本文改进后的算法训练好的模型中进行识别。在模型训练的过程中，本文是采用多种优化器搭配本文提出的最优权重重载算法来训练各种网络模型，最终选择resnet18这个网络训练出的人脸模型来应用于人脸识别模块中。因为resnet18相对轻量化并且表现出的性能是非常的可观。

4.2.2.4		其他功能
（1）用户管理功能
人脸识别模块作为审计系统的一部分，需要区分访问用户的权限，毕竟人脸信息是数据隐私信息，并不是所有人都能够访问的到，因此，设计出用户管理功能是非常有必要性。进入人脸识别模块有两种途径，第一种是通过审计系统跳转，将用户登录信息共享到当前的人脸识别模块系统，第二种是直接通过人脸识别模块系统的登录界面输入用户名和密码登录。
管理用户的权限只能是管理员才能拥有的，主要是能够添加删除或者点击审计人员和飞检人员的用户权限信息。
而非管理员用户只能修改自己的相关信息，不能修改权限信息。这样权责分明，有利于提高飞检员和审计人员的工作效率。
使用flask框架自带的session会话能够有效的用户的状态管理，区分用户的角色和权限。使得用户即时跳转页面也不影响他的登录状态。
	（2）活动管理功能 
飞检员在活动页面创建活动记录，并进行修改，同时添加与之相关的现场人脸图像集。
审计人员通过查看人脸图像识别出的结果进行活动风险评估。
4.2.3	效果展示 
	登录当前系统后，或者从设计系统跳转过来的默认页面如4-10所示。
在这个界面中，有活动管理，人脸管理，设计报告结果，以及用户相关信息及设置。
在人脸检测页面中，选择需要上传的图像，点击检测按钮，然后对这个图像进行人脸检测，得出检测结果呈现在页面上（见图4-11）。

人脸识别：选择已经切割好的人脸图像集，等待识别结果，然后人脸集中的所有人脸就会识别结果展示在页面上如图4-12所示。

4.3	本章小结
本章介绍了基于审计调查的人脸识别模块的研发与应用的整个过程，包括系统的需求分析，技术方案的选型，数据库的设计以及详细的功能设计，还有最后整个系统的效果展示。

